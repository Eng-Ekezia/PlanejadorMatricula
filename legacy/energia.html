<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento de Matrícula - Engenharia de Energia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .subject-card { transition: all 0.2s ease-in-out; position: relative; display: flex; align-items: center; justify-content: center; text-align: center; }
        .subject-card.completed { background-color: #6b7280 !important; border-color: #4b5563 !important; color: white !important; }
        .subject-card.planned { background-color: #fef08a !important; border-color: #facc15 !important; transform: scale(1.05); animation: pulse 2s infinite; }
        .subject-card.can-take { background-color: #d1fae5 !important; border-color: #10b981 !important; }
        .subject-card.locked { background-color: #f3f4f6 !important; border-color: #d1d5db !important; color: #9ca3af; opacity: 0.6; cursor: not-allowed; }
        .subject-card.is-hover-origin { background-color: #fef9c3 !important; border-color: #fde047 !important; z-index: 10; }
        .subject-card.highlight-prereq { background-color: #c7d2fe !important; border-color: #818cf8 !important; }
        .subject-card.highlight-coreq { background-color: #f5d0fe !important; border-color: #e879f9 !important; }
        .subject-card.highlight-direct-dependent { background-color: #fecaca !important; border-color: #ef4444 !important; }
        .subject-card.highlight-indirect-dependent { background-color: #fca5a5 !important; border-color: #b91c1c !important; }
        html.dark, .dark body { background-color: #0a0a0a; color: #d1d5db; }
        .dark header, .dark #progress-counter, .dark .bg-white, .dark .modal-content, .dark .course-toggle { background-color: #121212 !important; color: #d1d5db !important; border-color: #374151 !important;}
        .dark h1, .dark h2, .dark #progress-counter span, .dark p, .dark .font-bold { color: #f9fafb !important; }
        .dark .text-blue-600 { color: #38bdf8 !important; }
        .dark .text-yellow-600 { color: #fde047 !important; }
        .dark .border-b-2 { border-color: #0ea5e9 !important; }
        .dark .subject-card.completed { background-color: #374151 !important; border-color: #9ca3af !important; transform: scale(1); box-shadow: none;}
        .dark .subject-card.planned { background-color: rgba(250, 204, 21, 0.1) !important; border-color: #facc15 !important; box-shadow: 0 0 8px rgba(250, 204, 21, 0.6); animation: pulseDark 2s infinite; }
        .dark .subject-card.can-take { background-color: rgba(16, 185, 129, 0.1) !important; border-color: #10b981 !important; }
        .dark .subject-card.locked { background-color: #1f2937 !important; border-color: #374151 !important; color: #6b7280 !important; opacity: 0.6; }
        .dark .subject-card.is-hover-origin { background-color: rgba(254, 249, 195, 0.2) !important; border-color: #fde047 !important; }
        .dark .subject-card.highlight-prereq { background-color: rgba(99, 102, 241, 0.3) !important; border-color: #818cf8 !important; }
        .dark .subject-card.highlight-coreq { background-color: rgba(217, 70, 239, 0.3) !important; border-color: #e879f9 !important; }
        .dark .subject-card.highlight-direct-dependent { background-color: rgba(239, 68, 68, 0.3) !important; border-color: #ef4444 !important; }
        .dark .subject-card.highlight-indirect-dependent { background-color: rgba(185, 28, 28, 0.3) !important; border-color: #b91c1c !important; }
        .dark .bg-gray-200 { background-color: #374151; }
        .dark .text-gray-700, .dark .text-gray-600, .dark .text-green-600, .dark .text-red-500, .dark .text-gray-500, .dark .subject-card h3 { color: #e5e7eb !important; }
        .dark .subject-card.locked h3 { color: #6b7280 !important; }
        .dark .legend-completed { background-color: #374151 !important; border-color: #6b7280 !important; }
        .dark .legend-planned { background-color: #422006 !important; border-color: #facc15 !important; }
        .dark .legend-can-take { background-color: #064e3b !important; border-color: #10b981 !important; }
        .dark .legend-hover { background-color: #422006 !important; border-color: #fde047 !important; }
        .dark .legend-prereq { background-color: #312e81 !important; border-color: #818cf8 !important; }
        .dark .legend-coreq { background-color: #581c87 !important; border-color: #e879f9 !important; }
        .dark .legend-dep-direct { background-color: #7f1d1d !important; border-color: #ef4444 !important; }
        .dark .legend-dep-indirect { background-color: #7f1d1d !important; border-color: #b91c1c !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); } }
        @keyframes pulseDark { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); } }
        #toast-notification { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-40px); opacity: 0; transition: all 0.3s ease; }
        #toast-notification.show { transform: translateY(0); opacity: 1; }
        .mobile-period-row { display: flex; align-items: stretch; margin-bottom: 0.5rem; }
        .mobile-period-header { flex-shrink: 0; writing-mode: vertical-rl; transform: rotate(180deg); padding: 0.5rem 0.25rem; background-color: #e5e7eb; font-weight: 600; border-radius: 8px 0 0 8px; text-align: center; cursor: pointer; }
        .dark .mobile-period-header { background-color: #374151; }
        .mobile-cards-container { display: flex; overflow-x: auto; padding: 0.5rem; flex-grow: 1; gap: 0.5rem; scrollbar-width: thin; scrollbar-color: #a1a1aa #f1f5f9; }
        .dark .mobile-cards-container { scrollbar-color: #52525b #1f2937; }
        .mobile-cards-container::-webkit-scrollbar { height: 8px; }
        .mobile-cards-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark .mobile-cards-container::-webkit-scrollbar-track { background: #1f2937; }
        .mobile-cards-container::-webkit-scrollbar-thumb { background-color: #a1a1aa; border-radius: 4px; }
        .dark .mobile-cards-container::-webkit-scrollbar-thumb { background-color: #52525b; }
        .mobile-subject-card { flex-shrink: 0; width: 60px; height: 60px; font-size: 0.65rem; line-height: 0.8rem; padding: 2px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="main-content" class="container mx-auto p-2 md:p-6 lg:p-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl md:text-4xl font-bold text-gray-900">Planejamento de Matrícula</h1>
                <p class="text-md md:text-lg text-gray-600 mt-1 md:mt-2">Engenharia de Energia - CEFET-MG</p>
            </div>
            <div id="progress-counter" class="w-full md:w-auto mt-4 md:mt-0 bg-white p-3 rounded-lg shadow-md text-left border border-gray-200">
                <h3 class="font-semibold text-gray-500 mb-2 text-center text-base">Progresso</h3>
                <div class="grid grid-cols-2 gap-x-4">
                    <div><span class="font-semibold text-gray-700 text-sm">Horas Cursadas:</span> <span id="total-hours-completed" class="font-bold text-blue-600">0</span></div>
                    <div><span class="font-semibold text-gray-700 text-sm">Créditos Cursados:</span> <span id="total-credits-completed" class="font-bold text-blue-600">0</span></div>
                    <div><span class="font-semibold text-gray-700 text-sm">Horas Planejadas:</span> <span id="total-hours-planned" class="font-bold text-yellow-600">0</span></div>
                    <div><span class="font-semibold text-gray-700 text-sm">Créditos Planejados:</span> <span id="total-credits-planned" class="font-bold text-yellow-600">0</span></div>
                </div>
            </div>
        </header>
        
        <div class="md:flex md:justify-between md:items-center md:gap-4 mb-6">
            <div class="flex-1 mb-4 md:mb-0 p-4 bg-white rounded-lg shadow">
                 <div class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:flex-wrap items-center gap-x-4 gap-y-2">
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-gray-500 border-2 border-gray-600 legend-completed"></div><span class="text-sm ml-2">Já Cursei</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-yellow-200 border-2 border-yellow-400 legend-planned"></div><span class="text-sm ml-2">Planejo Cursar</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-green-200 border-2 border-green-500 legend-can-take"></div><span class="text-sm ml-2">Posso Cursar</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-yellow-100 border-2 border-yellow-300 legend-hover"></div><span class="text-sm ml-2">Destacada</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-indigo-200 border-2 border-indigo-400 legend-prereq"></div><span class="text-sm ml-2">Pré-req.</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-fuchsia-200 border-2 border-fuchsia-400 legend-coreq"></div><span class="text-sm ml-2">Co-req.</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md bg-red-200 border-2 border-red-400 legend-dep-direct"></div><span class="text-sm ml-2">Req. Direto</span></div>
                    <div class="flex items-center"><div class="w-5 h-5 rounded-md legend-dep-indirect" style="background-color: #fca5a5; border: 2px solid #b91c1c;"></div><span class="text-sm ml-2">Req. Indireto</span></div>
                 </div>
            </div>
    
            <div class="p-2 bg-white rounded-lg shadow">
                <div class="flex items-center gap-2 flex-wrap justify-center">
                     <button id="viewToggle" class="bg-gray-200 text-gray-700 font-bold p-2 rounded-full shadow hover:bg-gray-300 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Mudar Visualização">
                        <svg id="view-icon-desktop" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                        <svg id="view-icon-mobile" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    </button>
                    <button id="textToggle" class="bg-gray-200 text-gray-700 font-bold p-2 rounded-full shadow hover:bg-gray-300 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Mudar Texto da Disciplina">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>
                    </button>
                     <button id="theme-toggle" class="bg-gray-200 text-gray-700 font-bold p-2 rounded-full shadow hover:bg-gray-300 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Mudar tema">
                        <svg id="theme-icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <svg id="theme-icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                     </button>
                     <button id="helpButton" class="bg-gray-200 text-gray-700 font-bold p-2 rounded-full shadow hover:bg-gray-300 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Ajuda">?</button>
                     <button id="exportPdfButton" class="bg-green-600 text-white font-bold p-2 rounded-full shadow hover:bg-green-700 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Exportar PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                     </button>
                     <button id="resetButton" class="bg-blue-600 text-white font-bold p-2 rounded-full shadow hover:bg-blue-700 transition-colors h-9 w-9 flex items-center justify-center" aria-label="Limpar Plano">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                     </button>
                </div>
            </div>
        </div>

        <div id="course-grid-container">
            <div id="desktop-grid" class="grid grid-cols-10 gap-2"></div>
            <div id="mobile-grid" class="hidden space-y-2"></div>
        </div>
    </div>

    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50" role="dialog" aria-modal="true">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Como Usar o Planejador</h2>
            <div class="space-y-3 text-gray-700">
                <p><strong>1. Marcar Disciplinas:</strong> Clique ou pressione Enter em uma disciplina para mudar seu status ('Planejar', 'Cursei').</p>
                <p><strong>2. Seleção Rápida:</strong> Clique no título de um período (ex: "1P") para marcar todas as disciplinas disponíveis.</p>
                <p><strong>3. Ver Requisitos:</strong> Passe o mouse sobre uma disciplina para destacar suas dependências com cores.</p>
                <p><strong>4. Controlos da Interface:</strong> Use os botões no canto superior direito para:</p>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Alternar entre a vista mobile e desktop.</li>
                    <li>Alternar entre nomes completos e abreviados (na vista desktop).</li>
                    <li>Mudar para o tema escuro.</li>
                    <li>Exportar o seu plano como PDF.</li>
                    <li>Limpar todo o planeamento.</li>
                </ul>
                <div class="!mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="font-bold text-blue-800">Atenção:</p>
                    <p class="text-blue-700">Para que a matrícula seja efetivada, o aluno precisa se matricular em, no mínimo, <strong>2 disciplinas</strong>.</p>
                </div>
            </div>
            <div class="text-right mt-6">
                <button id="closeHelpModal" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-blue-700 transition-colors">Entendi</button>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden" role="status" aria-live="polite"></div>

    <script>
        // IIFE para encapsular o escopo e evitar poluição global
        (function() {
            // Dados das disciplinas com abreviações
            const subjectsData = [
                { id: "calc1", name: "Cálculo com Funções de uma Variável Real", abbr: "CFVR", period: 1, prereqs: [], coreqs: [], hours: 75, credits: 6 }, { id: "gaal", name: "Geometria Analítica e Álgebra Linear", abbr: "GAAL", period: 1, prereqs: [], coreqs: [], hours: 50, credits: 4 }, { id: "quimica", name: "Química", abbr: "QG", period: 1, prereqs: [], coreqs: [], hours: 50, credits: 4 }, { id: "lab_quimica", name: "Laboratório de Química", abbr: "LQG", period: 1, prereqs: [], coreqs: ["quimica"], hours: 25, credits: 2 }, { id: "pci1", name: "Programação de Computadores I - PCI", abbr: "PCI1", period: 1, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "lab_pci1", name: "Laboratório de PCI", abbr: "LPC1", period: 1, prereqs: [], coreqs: ["pci1"], hours: 25, credits: 2 }, { id: "lpt", name: "Leitura e Produção de Textos Acadêmicos", abbr: "LPT", period: 1, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "energia_sust", name: "Energia e Sustentabilidade", abbr: "ESUS", period: 1, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "contexto_eng", name: "Contexto Social e Profissional da Engenharia de Energia", abbr: "CSPE", period: 1, prereqs: [], coreqs: [], hours: 25, credits: 2 },
                { id: "calc_var2", name: "Cálculo com Funções de Várias Variáveis I", abbr: "CVV1", period: 2, prereqs: ["calc1", "gaal"], coreqs: [], hours: 50, credits: 4 }, { id: "int_series", name: "Integração e Séries", abbr: "IS", period: 2, prereqs: ["calc1"], coreqs: [], hours: 50, credits: 4 }, { id: "fund_mecanica", name: "Fundamentos de Mecânica", abbr: "FMEC", period: 2, prereqs: ["calc1", "gaal"], coreqs: [], hours: 50, credits: 4 }, { id: "fis_exp_mec", name: "Física Experimental - Mecânica", abbr: "FEM", period: 2, prereqs: [], coreqs: ["fund_mecanica"], hours: 25, credits: 2 }, { id: "pci2", name: "Programação de Computadores II - PCII", abbr: "PCI2", period: 2, prereqs: ["pci1", "lab_pci1"], coreqs: [], hours: 25, credits: 2 }, { id: "lab_pci2", name: "Laboratório de PCII", abbr: "LPC2", period: 2, prereqs: ["pci1", "lab_pci1"], coreqs: ["pci2"], hours: 25, credits: 2 }, { id: "des_tec", name: "Desenho Técnico Assistido por Computador", abbr: "DTAC", period: 2, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "sist_digitais", name: "Sistemas Digitais", abbr: "SD", period: 2, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "lab_sist_digitais", name: "Laboratório de Sistemas Digitais", abbr: "LSD", period: 2, prereqs: [], coreqs: ["sist_digitais"], hours: 25, credits: 2 },
                { id: "calc_var3", name: "Cálculo com Funções de Várias Variáveis II", abbr: "CVV2", period: 3, prereqs: ["calc_var2", "int_series"], coreqs: [], hours: 50, credits: 4 }, { id: "edo", name: "Equações Diferenciais Ordinárias", abbr: "EDO", period: 3, prereqs: ["calc_var2", "int_series"], coreqs: [], hours: 50, credits: 4 }, { id: "fund_oft", name: "Fundamentos de Oscilações, Fluidos e Termodinâmica - OFT", abbr: "FOFT", period: 3, prereqs: ["fund_mecanica"], coreqs: [], hours: 50, credits: 4 }, { id: "fis_exp_oft", name: "Física Experimental - OFT", abbr: "FEOFT", period: 3, prereqs: [], coreqs: ["fund_oft"], hours: 25, credits: 2 }, { id: "ciencia_mat", name: "Ciências dos Materiais", abbr: "CMAT", period: 3, prereqs: ["quimica", "lab_quimica"], coreqs: [], hours: 25, credits: 2 }, { id: "met_num", name: "Métodos Numéricos Computacionais", abbr: "MNC", period: 3, prereqs: ["pci1", "lab_pci1"], coreqs: ["edo"], hours: 50, credits: 4 }, { id: "circuitos_elet", name: "Circuitos Elétricos", abbr: "CE", period: 3, prereqs: ["calc_var2", "int_series"], coreqs: ["edo"], hours: 50, credits: 4 }, { id: "lab_circuitos_elet", name: "Laboratório de Circuitos Elétricos", abbr: "LCE", period: 3, prereqs: [], coreqs: ["circuitos_elet"], hours: 25, credits: 2 },
                { id: "edp", name: "Equações Diferenciais Parciais", abbr: "EDP", period: 4, prereqs: ["edo"], coreqs: [], hours: 50, credits: 4 }, { id: "fund_eletromag", name: "Fundamentos de Eletromagnetismo", abbr: "FEMAG", period: 4, prereqs: ["fund_oft", "calc_var3"], coreqs: [], hours: 50, credits: 4 }, { id: "fis_exp_eletromag", name: "Física Experimental - Eletromagnetismo", abbr: "FEEM", period: 4, prereqs: [], coreqs: ["fund_eletromag"], hours: 25, credits: 2 }, { id: "estatistica", name: "Estatística Aplicada à Engenharia", abbr: "EST", period: 4, prereqs: ["int_series"], coreqs: [], hours: 37.5, credits: 3 }, { id: "ingles1", name: "Inglês Instrumental I", abbr: "ING1", period: 4, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "intro_direito", name: "Introdução ao Direito", abbr: "IDIR", period: 4, prereqs: ["lpt"], coreqs: [], hours: 25, credits: 2 }, { id: "eletronica", name: "Eletrônica", abbr: "ELET", period: 4, prereqs: ["ciencia_mat", "circuitos_elet", "lab_circuitos_elet"], coreqs: [], hours: 50, credits: 4 }, { id: "lab_eletronica", name: "Laboratório de Eletrônica", abbr: "LELE", period: 4, prereqs: [], coreqs: ["eletronica"], hours: 25, credits: 2 }, { id: "proj_int1", name: "Projeto Integrador I", abbr: "PI1", period: 4, prereqs: [], coreqs: [], hours: 12.5, credits: 1, minCredits: 48 }, { id: "termodinamica", name: "Termodinâmica", abbr: "TER", period: 4, prereqs: ["fund_oft"], coreqs: [], hours: 50, credits: 4 },
                { id: "mecanica_aplicada", name: "Mecânica Aplicada à Energia", abbr: "MAE", period: 5, prereqs: ["edp", "fund_mecanica"], coreqs: [], hours: 50, credits: 4 }, { id: "intro_sociologia", name: "Introdução à Sociologia", abbr: "ISOC", period: 5, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "adm_fin", name: "Administração Financeira", abbr: "AFIN", period: 5, prereqs: ["estatistica"], coreqs: [], hours: 50, credits: 4 }, { id: "leg_amb_energ", name: "Legislação Ambiental e Energética", abbr: "LAE", period: 5, prereqs: ["intro_direito"], coreqs: [], hours: 25, credits: 2 }, { id: "clima_mudancas", name: "Climatologia e Mudanças Climáticas", abbr: "CMC", period: 5, prereqs: ["energia_sust"], coreqs: [], hours: 50, credits: 4 }, { id: "elet_potencia", name: "Eletrônica de Potência", abbr: "EPOT", period: 5, prereqs: ["eletronica", "lab_eletronica"], coreqs: [], hours: 75, credits: 6 }, { id: "proj_instal_elet", name: "Projetos e Instalações Elétricas", abbr: "PIE", period: 5, prereqs: ["circuitos_elet", "des_tec"], coreqs: [], hours: 37.5, credits: 3 }, { id: "eletromagnetismo", name: "Eletromagnetismo", abbr: "EMAG", period: 5, prereqs: ["edp", "fund_eletromag"], coreqs: [], hours: 50, credits: 4 },
                { id: "fen_transp", name: "Fenômenos de Transporte", abbr: "FT", period: 6, prereqs: ["fund_oft"], coreqs: [], hours: 75, credits: 6 }, { id: "plan_energ", name: "Planejamento Energético e Prospecção", abbr: "PEP", period: 6, prereqs: ["leg_amb_energ"], coreqs: [], hours: 37.5, credits: 3 }, { id: "econ_aplicada", name: "Economia Aplicada à Energia", abbr: "EAE", period: 6, prereqs: ["adm_fin"], coreqs: [], hours: 25, credits: 2 }, { id: "intro_eng_seg", name: "Introdução à Engenharia de Segurança", abbr: "IES", period: 6, prereqs: [], coreqs: [], hours: 25, credits: 2, minCredits: 12 }, { id: "energia_solar", name: "Energia Solar", abbr: "ESOL", period: 6, prereqs: ["circuitos_elet", "lab_circuitos_elet", "clima_mudancas"], coreqs: ["elet_potencia"], hours: 50, credits: 4 }, { id: "hidrologia", name: "Hidrologia Aplicada", abbr: "HA", period: 6, prereqs: ["clima_mudancas"], coreqs: [], hours: 25, credits: 2 }, { id: "conv_ger_energia", name: "Conversão e Geração de Energia", abbr: "CGE", period: 6, prereqs: ["eletromagnetismo"], coreqs: ["fen_transp"], hours: 50, credits: 4 }, { id: "lab_conv_ger_energia", name: "Laboratório de Conversão e Geração de Energia", abbr: "LCGE", period: 6, prereqs: [], coreqs: ["conv_ger_energia"], hours: 25, credits: 2 }, { id: "met_cientifica", name: "Metodologia Científica", abbr: "MC", period: 6, prereqs: ["ingles1"], coreqs: [], hours: 25, credits: 2 },
                { id: "gestao_empreendedora", name: "Gestão Empreendedora", abbr: "GE", period: 7, prereqs: ["adm_fin"], coreqs: [], hours: 50, credits: 4 }, { id: "energia_termica", name: "Energia Térmica", abbr: "ET", period: 7, prereqs: ["termodinamica"], coreqs: [], hours: 50, credits: 4 }, { id: "sistemas_embarcados", name: "Sistemas Embarcados", abbr: "SE", period: 7, prereqs: ["eletronica", "lab_eletronica", "lab_pci2", "pci2"], coreqs: [], hours: 50, credits: 4 }, { id: "fund_controle", name: "Fundamentos de Controle", abbr: "FC", period: 7, prereqs: ["calc_var3", "circuitos_elet", "lab_circuitos_elet"], coreqs: [], hours: 50, credits: 4 }, { id: "energia_eolica", name: "Energia Eólica", abbr: "EEO", period: 7, prereqs: ["fen_transp", "conv_ger_energia", "lab_conv_ger_energia", "elet_potencia", "clima_mudancas"], coreqs: [], hours: 50, credits: 4 }, { id: "sist_elet_transm", name: "Sistemas Elétricos e Transmissão de Energia", abbr: "SETE", period: 7, prereqs: ["proj_instal_elet", "conv_ger_energia"], coreqs: [], hours: 50, credits: 4 }, { id: "proj_int2", name: "Projeto Integrador II", abbr: "PI2", period: 7, prereqs: ["proj_int1"], coreqs: [], hours: 12.5, credits: 1, minCredits: 96 },
                { id: "gestao_projetos", name: "Gestão de Projetos em Engenharia", abbr: "GPE", period: 8, prereqs: ["intro_eng_seg", "gestao_empreendedora"], coreqs: [], hours: 50, credits: 4 }, { id: "filosofia_tec", name: "Filosofia da Tecnologia", abbr: "FTC", period: 8, prereqs: [], coreqs: [], hours: 25, credits: 2 }, { id: "aut_sist_energia", name: "Automação em Sistemas de Energia", abbr: "ASE", period: 8, prereqs: ["sistemas_embarcados", "fund_controle"], coreqs: [], hours: 50, credits: 4 }, { id: "energia_hidraulica", name: "Energia Hidráulica", abbr: "EH", period: 8, prereqs: ["fen_transp", "conv_ger_energia", "lab_conv_ger_energia", "mecanica_aplicada", "hidrologia"], coreqs: [], hours: 37.5, credits: 3 }, { id: "armaz_energia", name: "Armazenamento de Energia", abbr: "ARE", period: 8, prereqs: ["eletronica", "lab_eletronica"], coreqs: [], hours: 25, credits: 2 }, { id: "met_pesquisa", name: "Metodologia da Pesquisa", abbr: "MP", period: 8, prereqs: ["met_cientifica"], coreqs: [], hours: 25, credits: 2 },
                { id: "mercado_energia", name: "Mercado de Energia", abbr: "MERE", period: 9, prereqs: ["plan_energ", "econ_aplicada"], coreqs: [], hours: 25, credits: 2 }, { id: "ger_dist_sist_dist", name: "Geração Distribuída e Sistemas de Distribuição", abbr: "GDSD", period: 9, prereqs: ["elet_potencia", "sist_elet_transm", "aut_sist_energia"], coreqs: [], hours: 50, credits: 4 }, { id: "mobilidade_eletrica", name: "Mobilidade elétrica", abbr: "MELE", period: 9, prereqs: ["armaz_energia"], coreqs: [], hours: 25, credits: 2 }, { id: "eficiencia_energetica", name: "Eficiência Energética", abbr: "EE", period: 9, prereqs: ["proj_instal_elet"], coreqs: [], hours: 50, credits: 4 },
                { id: "psi_org", name: "Psicologia Aplicada às Organizações", abbr: "PAO", period: 10, prereqs: ["intro_sociologia", "intro_direito"], coreqs: [], hours: 25, credits: 2 }, { id: "geopolitica_energia", name: "Geopolítica da Energia", abbr: "GEOE", period: 10, prereqs: ["mercado_energia"], coreqs: [], hours: 25, credits: 2 }, { id: "gestao_energetica", name: "Gestão Energética", abbr: "GENE", period: 10, prereqs: ["mercado_energia"], coreqs: [], hours: 25, credits: 2 },
            ];
            
            // Variáveis de Estado
            const state = {
                plannedIds: new Set(),
                completedIds: new Set(),
                periodClickState: {},
                subjectCards: {},
                subjectsById: {},
                dependentsOf: {},
                viewMode: 'auto', // auto, desktop, mobile
                isAbbreviated: false,
            };

            // Funções de Inicialização
            function initApp() {
                cacheDOMElements();
                addEventListeners();
                renderCourse(true);
            }

            function cacheDOMElements() {
                state.dom = {
                    desktopGrid: document.getElementById('desktop-grid'),
                    mobileGrid: document.getElementById('mobile-grid'),
                    resetButton: document.getElementById('resetButton'),
                    exportPdfButton: document.getElementById('exportPdfButton'),
                    helpButton: document.getElementById('helpButton'),
                    helpModal: document.getElementById('helpModal'),
                    closeHelpModal: document.getElementById('closeHelpModal'),
                    themeToggleButton: document.getElementById('theme-toggle'),
                    moonIcon: document.getElementById('theme-icon-moon'),
                    sunIcon: document.getElementById('theme-icon-sun'),
                    hoursCompletedEl: document.getElementById('total-hours-completed'),
                    creditsCompletedEl: document.getElementById('total-credits-completed'),
                    hoursPlannedEl: document.getElementById('total-hours-planned'),
                    creditsPlannedEl: document.getElementById('total-credits-planned'),
                    toast: document.getElementById('toast-notification'),
                    viewToggle: document.getElementById('viewToggle'),
                    viewIconDesktop: document.getElementById('view-icon-desktop'),
                    viewIconMobile: document.getElementById('view-icon-mobile'),
                    textToggle: document.getElementById('textToggle'),
                };
            }
            
            function precomputeDependencies() {
                state.subjectsById = subjectsData.reduce((acc, s) => { acc[s.id] = s; return acc; }, {});
                state.dependentsOf = {};
                subjectsData.forEach(s => { state.dependentsOf[s.id] = []; });
                subjectsData.forEach(subject => {
                    subject.prereqs.forEach(prereqId => {
                        if (state.dependentsOf[prereqId]) {
                            state.dependentsOf[prereqId].push(subject.id);
                        }
                    });
                });
            }

            // Lógica de Estado
            function loadStateFromStorage() {
                const savedState = localStorage.getItem('plannerState_energia');
                if (savedState) {
                    try {
                        const stored = JSON.parse(savedState);
                        state.plannedIds = new Set(stored.planned || []);
                        state.completedIds = new Set(stored.completed || []);
                    } catch (e) { console.error('Erro ao carregar estado do localStorage:', e); }
                }
            }
            
            function saveStateToStorage() {
                const dataToStore = { planned: [...state.plannedIds], completed: [...state.completedIds] };
                localStorage.setItem('plannerState_energia', JSON.stringify(dataToStore));
            }

            function renderCourse(isInitialLoad = false) {
                if(!isInitialLoad) {
                    resetAllStates(false);
                }
                precomputeDependencies();
                buildCourseGrids();
                addGridEventListeners();
                loadStateFromStorage();
                handleResize();
                updateUI();
            }

            // Construção da UI
            function buildCourseGrids() {
                state.dom.desktopGrid.innerHTML = '';
                state.dom.mobileGrid.innerHTML = '';
                state.subjectCards = {}; 
                
                const maxPeriod = Math.max(...subjectsData.map(s => s.period), 0);
                
                for (let i = 1; i <= maxPeriod; i++) {
                    state.periodClickState[i] = 0;
                }
                
                buildDesktopGrid();
                buildMobileGrid();
            }

            function buildDesktopGrid() {
                const maxPeriod = Math.max(...subjectsData.map(s => s.period), 0);
                const gridFragment = document.createDocumentFragment();

                for (let i = 1; i <= maxPeriod; i++) {
                    const periodContainer = document.createElement('div');
                    periodContainer.className = 'flex flex-col space-y-2';
                    
                    const header = document.createElement('h2');
                    header.className = 'text-base font-semibold text-center text-gray-700 pb-2 cursor-pointer border-b-2 border-blue-600';
                    header.dataset.period = i;
                    header.textContent = `${i}P`;
                    
                    periodContainer.appendChild(header);
                    
                    const periodSubjects = subjectsData.filter(s => s.period === i);
                    periodSubjects.forEach(subject => {
                         const card = createCard(subject);
                         periodContainer.appendChild(card);
                    });
                    gridFragment.appendChild(periodContainer);
                }
                state.dom.desktopGrid.appendChild(gridFragment);
            }

            function buildMobileGrid() {
                const maxPeriod = Math.max(...subjectsData.map(s => s.period), 0);
                const gridFragment = document.createDocumentFragment();

                for (let i = 1; i <= maxPeriod; i++) {
                    const row = document.createElement('div');
                    row.className = 'mobile-period-row';

                    const header = document.createElement('div');
                    header.className = 'mobile-period-header';
                    header.dataset.period = i;
                    header.textContent = `${i}P`;
                    
                    const cardsContainer = document.createElement('div');
                    cardsContainer.className = 'mobile-cards-container';
                    
                    const periodSubjects = subjectsData.filter(s => s.period === i);
                    periodSubjects.forEach(subject => {
                        const card = createCard(subject, true);
                        cardsContainer.appendChild(card);
                    });

                    row.append(header, cardsContainer);
                    gridFragment.appendChild(row);
                }
                state.dom.mobileGrid.appendChild(gridFragment);
            }

            function createCard(subject, isMobile = false) {
                const card = document.createElement('div');
                card.dataset.id = subject.id;
                card.className = isMobile ? 'mobile-subject-card' : 'min-h-100';
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Disciplina: ${subject.name}`);
                card.setAttribute('tabindex', '0');
                
                card.innerHTML = `
                    <div>
                        <h3 class="subject-full-name text-sm font-bold">${subject.name}</h3>
                        <h3 class="subject-abbr-name text-xs font-bold">${subject.abbr}</h3>
                    </div>`;

                if (!state.subjectCards[subject.id]) {
                    state.subjectCards[subject.id] = [];
                }
                state.subjectCards[subject.id].push(card);
                return card;
            }

            // Manipuladores de Eventos
            function addEventListeners() {
                window.addEventListener('resize', handleResize);
                state.dom.resetButton.addEventListener('click', () => resetAllStates(true));
                state.dom.exportPdfButton.addEventListener('click', exportToPdf);
                state.dom.helpButton.addEventListener('click', () => state.dom.helpModal.classList.remove('hidden'));
                state.dom.closeHelpModal.addEventListener('click', () => state.dom.helpModal.classList.add('hidden'));
                state.dom.themeToggleButton.addEventListener('click', toggleTheme);
                state.dom.viewToggle.addEventListener('click', toggleViewMode);
                state.dom.textToggle.addEventListener('click', toggleAbbreviation);
            }

            function addGridEventListeners() {
                const gridContainer = document.getElementById('course-grid-container');

                gridContainer.addEventListener('click', (e) => {
                    const card = e.target.closest('.subject-card');
                    if(card) {
                        handleCardClick(card.dataset.id);
                        return;
                    }
                    const header = e.target.closest('[data-period]');
                    if(header) {
                        handlePeriodHeaderClick(parseInt(header.dataset.period));
                    }
                });

                gridContainer.addEventListener('mouseover', (e) => {
                    const card = e.target.closest('.subject-card');
                    if (card) handleRequirementHighlight(card.dataset.id, true);
                });

                gridContainer.addEventListener('mouseout', (e) => {
                    const card = e.target.closest('.subject-card');
                    if (card) handleRequirementHighlight(card.dataset.id, false);
                });

                gridContainer.addEventListener('keydown', (e) => {
                     const card = e.target.closest('.subject-card');
                     if(card && (e.key === 'Enter' || e.key === ' ')) {
                         e.preventDefault();
                         handleCardClick(card.dataset.id);
                     }
                });
            }


            function handleRequirementHighlight(subjectId, shouldHighlight) {
                const subject = state.subjectsById[subjectId];
                if (!subject) return;
                
                const toggleClass = (id, className) => {
                    if (state.subjectCards[id]) {
                        state.subjectCards[id].forEach(card => {
                            card.classList.toggle(className, shouldHighlight);
                        });
                    }
                };

                toggleClass(subjectId, 'is-hover-origin');
                subject.prereqs.forEach(id => toggleClass(id, 'highlight-prereq'));
                subject.coreqs.forEach(id => toggleClass(id, 'highlight-coreq'));
                
                const directDependents = state.dependentsOf[subjectId] || [];
                const indirectDependents = new Set();
                directDependents.forEach(directId => {
                    toggleClass(directId, 'highlight-direct-dependent');
                    (state.dependentsOf[directId] || []).forEach(indirectId => {
                        if (!directDependents.includes(indirectId)) indirectDependents.add(indirectId);
                    });
                });
                indirectDependents.forEach(indirectId => toggleClass(indirectId, 'highlight-indirect-dependent'));
            }

            function handleCardClick(id) {
                const cards = state.subjectCards[id];
                if (!cards || cards.length === 0 || cards[0].classList.contains('locked')) return;
                
                const isPlanned = state.plannedIds.has(id);
                const isCompleted = state.completedIds.has(id);
                
                if (isCompleted) {
                    state.completedIds.delete(id);
                } else if (isPlanned) {
                    state.plannedIds.delete(id);
                    state.completedIds.add(id);
                } else {
                    state.plannedIds.add(id);
                    const subject = state.subjectsById[id];
                    if (subject && subject.coreqs) {
                        subject.coreqs.forEach(coreqId => {
                            if (!state.completedIds.has(coreqId) && !state.plannedIds.has(coreqId)) {
                                state.plannedIds.add(coreqId);
                                const coreqSubject = state.subjectsById[coreqId];
                                if (coreqSubject) {
                                    showToast(`${coreqSubject.abbr} adicionado como co-requisito.`);
                                }
                            }
                        });
                    }
                }
                updateUI();
            }

            function handlePeriodHeaderClick(period) {
                const subjectsInPeriod = subjectsData.filter(s => s.period === period);
                const canTakeIds = getCanTakeIds();
                const canTakeAnyInPeriod = subjectsInPeriod.some(s => canTakeIds.has(s.id));
                
                if (!canTakeAnyInPeriod && subjectsInPeriod.every(s => !state.plannedIds.has(s.id))) {
                    const hasCompletedAll = subjectsInPeriod.every(s => state.completedIds.has(s.id));
                     if (!hasCompletedAll) {
                       showToast("Cumpra os pré-requisitos primeiro!", "error");
                       return;
                    }
                }

                const currentCycle = state.periodClickState[period] % 3;
                
                if (currentCycle === 0) {
                    subjectsInPeriod.forEach(s => { 
                        if (canTakeIds.has(s.id) && !state.completedIds.has(s.id)) {
                            state.plannedIds.add(s.id); 
                        }
                    });
                } else if (currentCycle === 1) {
                    subjectsInPeriod.forEach(s => {
                        if (state.plannedIds.has(s.id) || canTakeIds.has(s.id)) {
                            state.plannedIds.delete(s.id);
                            state.completedIds.add(s.id);
                        }
                     });
                } else {
                    subjectsInPeriod.forEach(s => { 
                        state.plannedIds.delete(s.id);
                        state.completedIds.delete(s.id); 
                    });
                }
                
                state.periodClickState[period]++;
                updateUI();
            }
            
            // Atualização da UI
            function updateUI() {
                updateProgressCounters();
                updateAllCardStyles();
                updateCardNamesVisibility();
                saveStateToStorage();
            }

            function updateAllCardStyles() {
                const canTakeIds = getCanTakeIds();
                Object.keys(state.subjectsById).forEach(id => {
                    let baseClasses = ['subject-card', 'cursor-pointer', 'p-2', 'rounded-lg', 'border-2', 'shadow-sm'];
                    
                    if (state.completedIds.has(id)) {
                        baseClasses.push('completed');
                    } else if (state.plannedIds.has(id)) {
                        baseClasses.push('planned');
                    } else if (canTakeIds.has(id)) {
                        baseClasses.push('can-take');
                    } else {
                        baseClasses.push('locked');
                    }
                    
                    if(state.subjectCards[id]) {
                        state.subjectCards[id].forEach(card => {
                            const mobileClass = card.classList.contains('mobile-subject-card') ? 'mobile-subject-card' : 'min-h-100';
                            card.className = [...baseClasses, mobileClass].join(' ');
                        });
                    }
                });
            }

            function updateProgressCounters() {
                const completed = calculateTotals(state.completedIds);
                const planned = calculateTotals(state.plannedIds);
                state.dom.hoursCompletedEl.textContent = completed.hours.toFixed(1);
                state.dom.creditsCompletedEl.textContent = completed.credits;
                state.dom.hoursPlannedEl.textContent = planned.hours.toFixed(1);
                state.dom.creditsPlannedEl.textContent = planned.credits;
            }

            function updateCardNamesVisibility() {
                const isMobileLayout = state.dom.mobileGrid.style.display !== 'none' && state.dom.mobileGrid.style.display !== '';
                const showAbbr = isMobileLayout || state.isAbbreviated;

                document.querySelectorAll('.subject-card').forEach(card => {
                    const fullNameEl = card.querySelector('.subject-full-name');
                    const abbrNameEl = card.querySelector('.subject-abbr-name');
                    
                    if (fullNameEl && abbrNameEl) {
                        fullNameEl.style.display = showAbbr ? 'none' : 'block';
                        abbrNameEl.style.display = showAbbr ? 'block' : 'none';
                    }
                });
            }

            function getCanTakeIds() {
                const canTake = new Set();
                const totalCreditsCompleted = calculateTotals(state.completedIds).credits;
                const currentSubjects = subjectsData;

                const initiallyAvailable = new Set();
                currentSubjects.forEach(subject => {
                    if (state.completedIds.has(subject.id) || state.plannedIds.has(subject.id)) return;
                    const prereqsMet = subject.prereqs.every(pr => state.completedIds.has(pr));
                    const creditsMet = !subject.minCredits || totalCreditsCompleted >= subject.minCredits;
                    if (prereqsMet && creditsMet) {
                        initiallyAvailable.add(subject.id);
                    }
                 });

                initiallyAvailable.forEach(id => {
                    const subject = state.subjectsById[id];
                    const coreqsMet = subject.coreqs.every(coreqId => 
                        state.completedIds.has(coreqId) || 
                        state.plannedIds.has(coreqId) || 
                        initiallyAvailable.has(coreqId)
                    );
                    if (coreqsMet) {
                        canTake.add(id);
                    }
                });
                return canTake;
            }
            
            function calculateTotals(idSet) {
                return [...idSet].reduce((acc, id) => {
                    const subject = state.subjectsById[id];
                    if (subject) {
                        acc.hours += subject.hours;
                        acc.credits += subject.credits;
                    }
                    return acc;
                }, { hours: 0, credits: 0 });
            }

            function toggleTheme() {
                document.documentElement.classList.toggle('dark');
                state.dom.moonIcon.classList.toggle('hidden');
                state.dom.sunIcon.classList.toggle('hidden');
            }

            function toggleViewMode() {
                if (state.viewMode === 'auto') {
                    state.viewMode = window.innerWidth < 768 ? 'desktop' : 'mobile';
                } else if (state.viewMode === 'desktop') {
                    state.viewMode = 'mobile';
                } else {
                    state.viewMode = 'auto';
                }
                handleResize();
            }

            function toggleAbbreviation() {
                state.isAbbreviated = !state.isAbbreviated;
                updateCardNamesVisibility();
            }
            
            function handleResize() {
                let showMobile = false;
                if (state.viewMode === 'auto') {
                    showMobile = window.innerWidth < 768;
                } else {
                    showMobile = state.viewMode === 'mobile';
                }

                if(showMobile) {
                    state.dom.desktopGrid.style.display = 'none';
                    state.dom.mobileGrid.style.display = 'block';
                    state.dom.viewIconDesktop.classList.add('hidden');
                    state.dom.viewIconMobile.classList.remove('hidden');
                } else {
                    state.dom.desktopGrid.style.display = 'grid';
                    state.dom.mobileGrid.style.display = 'none';
                    state.dom.viewIconDesktop.classList.remove('hidden');
                    state.dom.viewIconMobile.classList.add('hidden');
                }
                updateCardNamesVisibility();
            }
            
            function resetAllStates(update = true) {
                state.plannedIds.clear();
                state.completedIds.clear();
                Object.keys(state.periodClickState).forEach(k => state.periodClickState[k] = 0);
                if (update) {
                    updateUI();
                }
            }

            function exportToPdf() {
                const element = document.getElementById('main-content');
                const opt = {
                    margin:       0.2,
                    filename:     `planejamento_energia.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, logging: false },
                    jsPDF:        { unit: 'in', format: 'a3', orientation: 'landscape' }
                };

                const plannedCards = element.querySelectorAll('.planned');
                plannedCards.forEach(card => card.style.transform = 'none');

                html2pdf().from(element).set(opt).save().then(() => {
                     plannedCards.forEach(card => card.style.transform = '');
                });
            }
            
            function showToast(message, type = 'success') {
                const toast = state.dom.toast;
                toast.textContent = message;
                toast.style.backgroundColor = type === 'success' ? '#22c55e' : '#ef4444';
                toast.classList.remove('hidden');
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000);
            }

            initApp();
        })();
    </script>
</body>
</html>
